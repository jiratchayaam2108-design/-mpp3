<script>
let txChar;

async function connect(){
  try{
    const device = await navigator.bluetooth.requestDevice({
      filters:[{ namePrefix:'BBC micro:bit' }],
      optionalServices:['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(
      '6e400001-b5a3-f393-e0a9-e50e24dcca9e'
    );

    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å micro:bit
    txChar = await service.getCharacteristic(
      '6e400002-b5a3-f393-e0a9-e50e24dcca9e'
    );

    await txChar.startNotifications();

    txChar.addEventListener('characteristicvaluechanged', e => {
      const msg = new TextDecoder().decode(e.target.value).trim();
      console.log("‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å micro:bit:", msg);

      // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: TEN,‡∏™‡∏°‡∏ä‡∏≤‡∏¢,02/3
      const data = msg.split(",");

      if(data.length >= 3){
        const name = data[1];
        const pos = data[2]; // 02/3

        const building = pos[0];
        const floor = pos[2];

        document.getElementById("alertBox").innerHTML =
          "üö® <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</b><br>" +
          "üë§ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: " + name + "<br>" +
          "üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ " + building +
          " ‡∏ä‡∏±‡πâ‡∏ô " + floor;
      }
    });

    document.getElementById("status").innerHTML =
      "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
  catch(err){
    document.getElementById("status").innerHTML =
      "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ Chrome)";
    console.error(err);
  }
}
</script>
