<script>
const UART_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

let rxChar;

async function connect(){

  if (!navigator.bluetooth) {
    document.getElementById("status").innerHTML =
      "‚ùå Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Bluetooth";
    return;
  }

  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "BBC micro:bit" }],
      optionalServices: [UART_SERVICE]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(UART_SERVICE);
    rxChar = await service.getCharacteristic(UART_RX);

    await rxChar.startNotifications();
    rxChar.addEventListener("characteristicvaluechanged", handleData);

    document.getElementById("status").innerHTML =
      "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

  } catch (err) {
    document.getElementById("status").innerHTML =
      "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(err);
  }
}

function handleData(e) {
  const msg = new TextDecoder().decode(e.target.value).trim();
  console.log("‡∏£‡∏±‡∏ö:", msg);

  if (msg === "ten") {
    document.getElementById("alert").innerHTML =
      "üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß!";
  }
}
</script>
